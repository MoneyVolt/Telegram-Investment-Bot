import json
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext, ConversationHandler

# Steps for ConversationHandler
SIGNUP, LOGIN, PAYMENT = range(3)

# File to store user data
USER_DATA_FILE = "user_data.json"

# Load user data
def load_user_data():
    try:
        with open(USER_DATA_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

# Save user data
def save_user_data(data):
    with open(USER_DATA_FILE, "w") as f:
        json.dump(data, f)

user_data = load_user_data()

# Start command
def start(update: Update, context: CallbackContext) -> None:
    reply_keyboard = [["Sign Up", "Login"]]
    update.message.reply_text(
        "Welcome to the bot! Please choose an option.",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True),
    )
    return SIGNUP

# Sign up handler
def sign_up(update: Update, context: CallbackContext) -> None:
    chat_id = update.message.chat_id
    if str(chat_id) in user_data:
        update.message.reply_text("You are already registered! Please log in.")
        return LOGIN
    update.message.reply_text("Please enter your username:")
    context.user_data['action'] = 'signup'
    return SIGNUP

def handle_username(update: Update, context: CallbackContext) -> None:
    chat_id = update.message.chat_id
    username = update.message.text
    user_data[str(chat_id)] = {"username": username, "is_logged_in": True}
    save_user_data(user_data)
    update.message.reply_text(f"Sign Up successful! Welcome, {username}.")
    return PAYMENT

# Login handler
def login(update: Update, context: CallbackContext) -> None:
    chat_id = update.message.chat_id
    if str(chat_id) not in user_data:
        update.message.reply_text("You are not registered! Please sign up first.")
        return SIGNUP
    user_data[str(chat_id)]["is_logged_in"] = True
    save_user_data(user_data)
    update.message.reply_text("Login successful! You are now logged in.")
    return PAYMENT

# Payment options
def payment(update: Update, context: CallbackContext) -> None:
    reply_keyboard = [["Easypaisa", "JazzCash", "Back"]]
    update.message.reply_text(
        "Select a payment option:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True),
    )
    return PAYMENT

def end(update: Update, context: CallbackContext) -> None:
    update.message.reply_text("Goodbye!")
    return ConversationHandler.END

def main():
    # Replace 'YOUR_API_TOKEN' with your bot's API token
    updater = Updater("YOUR_API_TOKEN")
    dispatcher = updater.dispatcher

    # Conversation handler
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            SIGNUP: [
                MessageHandler(Filters.regex("^(Sign Up)$"), sign_up),
                MessageHandler(Filters.text & ~Filters.command, handle_username),
            ],
            LOGIN: [
                MessageHandler(Filters.regex("^(Login)$"), login),
            ],
            PAYMENT: [
                MessageHandler(Filters.regex("^(Easypaisa|JazzCash)$"), payment),
                MessageHandler(Filters.regex("^Back$"), start),
            ],
        },
        fallbacks=[CommandHandler("end", end)],
    )

    dispatcher.add_handler(conv_handler)

    # Start bot
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
